<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->

    <link href="./VTP-Bottleneck_files/bootstrap.css" rel="stylesheet">
    <link href="./VTP-Bottleneck_files/addtl_styles.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/6364ea47c0.js" crossorigin="anonymous"></script>

    <script type="text/javascript">
      
    </script>

    <title>VTP-Bottleneck Tool</title>
  </head>
  <body>
    <div class = "container-fluid">
      <div class = "header ">
        <nav class="navbar navbar-expand-sm bg-purple">
          A Bottleneck Analysis Tool
        </nav>
      </div><!--Header-->
    <div class="row text-center justify-content-around">
      <div class="col-4"><button type="button" class="btn btn-responsive btn-primary">Check In > Voting > Scanning</button></div>
      <div class="col-4"><button type="button" class="btn btn-xlarge btn-secondary">Check In > Voting</button></div>
      <div class="col-4"><button type="button" class="btn btn-xlarge btn-secondary">Something Else?</button></div>
    </div>
    <br>
    <br>
    <div class = "row bg-purple">
      <div class="col-12 col-lg-4 bg-lightred col-md-offset-1">
        <div class="card">
          <h3 class = "text-center">Estimates Based on 2016</h3>  
          <table id="precoviddata", class = "table table-bordered table-striped" width="50%">
            <thead>
              <tr>
                <td>Task</td>
                <td>Number of Stations</td>
                <td>Average Time to Complete Task (min)</td>
                <td>Throughput (voters/hr)</td>                
              </tr>
            </thead>
            <tbody id = "precoviddatabody">
              <tr id = "preinput_0" class = "inputs">
                <td class="align-middle">Check In</td>
                <td><input type = "numeric" class = "form-control input-sm stations_input" value = "2"/></td>
                <td><input type = "numeric" class = "form-control input-sm time_input" value = "2"/></td>
                <td id = "preoutput_0" class="align-middle"></td>
              </tr>
              <tr id = "preinput_1" class = "inputs">
                <td class="align-middle">Voting</td>
                <td><input type = "numeric" class = "form-control input-sm stations_input" value = "12"/></td>
                <td><input type = "numeric" class = "form-control input-sm time_input" value = "6"/></td>
                <td id = "preoutput_1" class="align-middle"></td>
              </tr>
              <tr id = "preinput_2" class = "inputs">
                <td class="align-middle">Scanning</td>
                <td><input type = "numeric" class = "form-control input-sm stations_input" value = "2"/></td>
                <td><input type = "numeric" class = "form-control input-sm time_input" value = "1"/></td>
                <td id = "preoutput_2" class="align-middle"></td>
              </tr>
              <tr>
                <td colspan="2">Voter Arrival Rate (Voters/hr)</td>
                <td colspan="2"><input type="numeric" name="arrivalrate" class="form-control input-sm float-right" value = "45" id="voterrate"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-12 col-lg-4 bg-lightred">
        <div class="card">
          <h3 class = "text-center">Social Distancing Changes</h3>
          <table class="table table-bordered"  id="checkboxtable">
            <thead>
              <tr>
                <td>Change</td>
                <td>Parameter</td>
              </tr>
            </thead>
            <tbody>
              <tr><!-- Voting Booths -->
                <td>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="customCheck1" checked onchange="handleCheck(inputelem = this)">
                    <label class="custom-control-label" for="customCheck1">Fewer Voting Booths</label>
                  </div>
                </td>
                <td><input type="numeric" name="boothreduciton" class="form-control input-sm entry" value = "50"/><span class="help-block">Percent Reduction</span></td>
              </tr>
              <tr><!-- Cleaning -->
                <td>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="customCheck2" checked onchange="handleCheck(this)">
                    <label class="custom-control-label" for="customCheck2">Cleaning Booths</label>
                  </div>
                </td>
                <td><input type="numeric" name="boothreduciton" class="form-control input-sm entry" value = "10"  id = "test"><span class="help-block">Cleaned every (X) voters</span></td>
              </tr>
              <tr><!-- Longer Check In -->
                <td>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="customCheck3" checked onchange="handleCheck(this)">
                    <label class="custom-control-label" for="customCheck3">Longer Check In Time</label>
                  </div>
                </td>
                <td><input type="numeric" name="boothreduciton" class="form-control input-sm entry" value = "0.5"><span class="help-block">Additional Minutes</span></td>
              </tr>
              <tr><!-- Absentee Voters -->
                <td>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="customCheck4" checked onchange="handleCheck(this)">
                    <label class="custom-control-label" for="customCheck4">Increase in Absentee</label>
                  </div>
                </td>
                <td><input type="numeric" name="boothreduciton" class="form-control input-sm entry" value = "50"><span class="help-block">% of in-person voters now absentee</span></td>
              </tr>
            </tbody>
          </table> <!--Table-->
        </div><!--Card-->
      </div><!--Col-->
      <div class="col-12 col-lg-4 bg-lightred col-md-offset-1">
        <div class="card">
          <h3 class = "text-center">Estimates of 2020</h3>  
          <table id="postcoviddata", class = "table table-bordered table-striped" width="50%">
            <thead>
              <tr>
                <td>Task</td>
                <td>Number of Stations</td>
                <td>Average Time to Complete Task (min)</td>
                <td>Throughput (voters/hr)</td>                
              </tr>
            </thead>
            <tbody id = "postcoviddatabody">
              <tr id = "poststats_0" class = "outputs">
                <td class="align-middle">Check In</td>
                <td class="stations_output"></td>
                <td class="time_output"></td>
                <td id = "postoutput_0" class="throughput_output align-middle"></td>
              </tr>
              <tr id = "poststats_1" class = "outputs">
                <td class="align-middle">Voting</td>
                <td class="stations_output"></td>
                <td class="time_output"></td>
                <td id = "postoutput_1" class="throughput_output align-middle"></td>
              </tr>
              <tr id = "poststats_2" class = "outputs">
                <td class="align-middle">Scanning</td>
                <td class="stations_output"></td>
                <td class="time_output"></td>
                <td id = "postoutput_2" class="throughput_output align-middle"></td>
              </tr>
              <tr>
                <td colspan="2">Voter Arrival Rate (Voters/hr)</td>
                <td colspan="2" id = "postvoterrate"></td>
              </tr>
            </tbody>
          </table>
        </div><!--Card-->
      </div><!--Col-->
    </div><!--Row-->
    </div><!--Container-->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="./VTP-Bottleneck_files/jquery-3.5.1.min.js"></script>
    <script src="./VTP-Bottleneck_files/popper.min.js"></script>
    <script src="./VTP-Bottleneck_files/bootstrap.bundle.min.js"></script>
    
    <script type="text/javascript">
      //Function for updating the output table
      function writeOutputTable(stations_values, changes_values, times_values, includeChanges){
        //console.log('hello');
        throughputs = [];
        //check in
        var rowToWrite = document.getElementById("poststats_0");
        rowToWrite.getElementsByClassName("stations_output")[0].innerHTML = stations_values[0];
        if(includeChanges[2]){
          var newTime = times_values[0]+changes_values[2];
          rowToWrite.getElementsByClassName("time_output")[0].innerHTML = newTime;
        } else {
          var newTime = times_values[0];
          rowToWrite.getElementsByClassName("time_output")[0].innerHTML = newTime;
        }
        throughputs.push(stations_values[0]*60/newTime);
        //rowToWrite.getElementsByClassName("throughput_output")[0].innerHTML = throughputs[throughputs.length-1];

        // voting booths
        var rowToWrite = document.getElementById("poststats_1");
        if(includeChanges[0]){
          var newStations = (stations_values[1]*(1-changes_values[0]/100)).toFixed(0);
          rowToWrite.getElementsByClassName("stations_output")[0].innerHTML = newStations;
        } else {
          var newStations = stations_values[1];
          rowToWrite.getElementsByClassName("stations_output")[0].innerHTML = newStations;
        }
        if(includeChanges[1]){
          var newTime = (times_values[1]*(1+1/changes_values[1])).toFixed(2);
          rowToWrite.getElementsByClassName("time_output")[0].innerHTML = newTime;
        } else {
          var newTime = times_values[1];
          rowToWrite.getElementsByClassName("time_output")[0].innerHTML = newTime;
        }
        throughputs.push((newStations*60/newTime).toFixed(2));
        //rowToWrite.getElementsByClassName("throughput_output")[0].innerHTML = throughputs[throughputs.length-1];

        //scanners
        var rowToWrite = document.getElementById("poststats_2");
        rowToWrite.getElementsByClassName("stations_output")[0].innerHTML = stations_values[2];
        rowToWrite.getElementsByClassName("time_output")[0].innerHTML = times_values[2];
        throughputs.push(stations_values[2]*60/times_values[2]);
        //rowToWrite.getElementsByClassName("throughput_output")[0].innerHTML = throughputs[throughputs.length-1];

        //arrival rate
        var prerate = document.getElementById('voterrate').value;
        if(includeChanges[3]){
          var postrate = prerate * (1-changes_values[3]/100);
        } else {
          var postrate = prerate;
        }
        document.getElementById('postvoterrate').innerHTML = postrate;


        //Calculate Bottleneck, write throughputs
        var rows = document.getElementById("postcoviddatabody").getElementsByClassName('outputs');
        var minVal = indexOfMin(throughputs);
        var numRows = rows.length;
        // write throughputs
        for(i = 0; i<numRows; i++){
          if(i==minVal){
            if(throughputs[i]<=postrate){
              // Report Bottleneck
              document.getElementById("postoutput_"+i.toString()).innerHTML = throughputs[i] + ' <button class="btn btn-danger btn-xs" \
                    data-toggle="tooltip" data-placement = "top" title="This is your new bottleneck. It does not have sufficient throughput to meet voter arrivals."><i class="fas fa-exclamation"></i></button>';

            } else {
              // Report Bottleneck
              document.getElementById("postoutput_"+i.toString()).innerHTML = throughputs[i] + ' <button class="btn btn-success btn-xs" \
                    data-toggle="tooltip" data-placement = "top" title="This is your new bottleneck"><i class="fas fa-exclamation"></i></button>';
            }

          } else {
            // Report Not Bottleneck
            document.getElementById("postoutput_"+i.toString()).innerHTML = throughputs[i];
          }
        }
        // Activate the tooltips
        $(function () {
          $('[data-toggle="tooltip"]').tooltip();
        });


      }
    </script>
    <script type="text/javascript">
    // Dynamically update minimum value to calculate throughput of the system and identify the bottleneck
      function indexOfMin(arr) {
          if (arr.length === 0) {
              return -1;
          }
      
          var min = arr[0];
          var minIndex = 0;
      
          for (var i = 1; i < arr.length; i++) {
              if (arr[i] < min) {
                  minIndex = i;
                  min = arr[i];
              }
          }
      
          return minIndex;
      }

      function updateThroughput(){
        var rows = document.getElementById("precoviddatabody").getElementsByClassName('inputs');
        var throughputs = [];
        // get data from the table
        for (let row of rows) {
          var sta = row.getElementsByClassName("stations_input")[0].value;
          var cyc = row.getElementsByClassName("time_input")[0].value;
          throughputs.push(sta*60/cyc);
        }
        // check if all data has been entered
        /*let allNums = throughputs.every(function(e){
          return (!Number.isNaN(e) & e<Infinity);
        })*/
        var minVal = indexOfMin(throughputs);
        var numRows = rows.length;
        // write throughputs
        for(i = 0; i<numRows; i++){
          if(i==minVal){
            // Report Bottleneck
            document.getElementById("preoutput_"+i.toString()).innerHTML = throughputs[i] + ' <button class="btn btn-success btn-xs" \
                    data-toggle="tooltip" data-placement = "top" title="This is your bottleneck"><i class="fas fa-exclamation"></i></button>';
          } else {
            // Report Not Bottleneck
            document.getElementById("preoutput_"+i.toString()).innerHTML = throughputs[i];
          }
        }
        // Activate the tooltips
        $(function () {
          $('[data-toggle="tooltip"]').tooltip();
        });
      }


      //function to update the pre-covid inputs
      //initialize inputs
      var numSteps = document.getElementById("precoviddatabody").getElementsByClassName('inputs').length;
      var stations_values = new Array(numSteps).fill(0);
      var times_values = new Array(numSteps).fill(0);
      function updateInputs() {
        var rows = document.getElementById("precoviddatabody").getElementsByClassName('inputs');
        for(i=0;i<rows.length; i++) {
          stations_values[i] = parseFloat(rows[i].getElementsByClassName("stations_input")[0].value);
          times_values[i] = parseFloat(rows[i].getElementsByClassName("time_input")[0].value);
        }
        console.log(stations_values);
        console.log(times_values);
      }

    </script>
    <script type="text/javascript">
      //function to find index
      function indexInParent(node) {
        var children = node.parentNode.childNodes;
        var num = 0;
        for (var i=0; i<children.length; i++) {
             if (children[i]==node) return num;
             if (children[i].nodeType==1) num++;
        }
        return -1;
      }
      //Deal with middle column checkboxes
      var numChanges = document.getElementById("checkboxtable").getElementsByTagName('tbody')[0].getElementsByTagName('tr').length;
      var includeChanges = new Array(numChanges).fill(true);
      changes_values = new Array(numChanges).fill(0);

      //function to disable the changes
      function handleCheck(inputelem){
        associatedInput = inputelem.closest('tr').getElementsByClassName('entry')[0];
        includeChanges[indexInParent(inputelem.closest('tr'))] = !includeChanges[indexInParent(inputelem.closest('tr'))];
        if(inputelem.checked){
          //if the box has been turned on
          associatedInput.disabled = false;
        } else {
          //if it has been turned off
          associatedInput.disabled = true;
        }
        writeOutputTable(stations_values, changes_values, times_values, includeChanges);
        console.log(includeChanges)
      }
      
      // function to update the values of the changes
      function updateChanges(){
        var changeEntries = document.getElementById("checkboxtable").getElementsByClassName("entry");
        for(i=0;i<changeEntries.length;i++) {
          changes_values[i] = parseFloat(changeEntries[i].value);
        }
        console.log(changes_values);
      }

    </script>

    <script type="text/javascript">
      //initialize
      updateChanges();
      updateInputs();
      updateThroughput();
      writeOutputTable(stations_values, changes_values, times_values, includeChanges);

      // add listeners for updates
      const input = document.getElementById("precoviddatabody").getElementsByTagName("input");
      for (let item of input) {
        item.addEventListener('blur', updateThroughput);
        item.addEventListener('blur', updateInputs);
        item.addEventListener('blur', function(){writeOutputTable(stations_values, changes_values, times_values, includeChanges)},false);
      }

      // add listeners for updates
      var changeEntriesGlob = document.getElementById("checkboxtable").getElementsByClassName("entry");
      for (let item of changeEntriesGlob) {
        item.addEventListener('blur', updateChanges);
        item.addEventListener('blur', function(){writeOutputTable(stations_values, changes_values, times_values, includeChanges)},false);
      }
    </script>

    <!--Tooltip Activation-->
    <script type="text/javascript">
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>


  </body>
</html>